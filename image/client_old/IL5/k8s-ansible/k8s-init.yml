---
- hosts: masters
  become: yes
  vars:
   lb_addr: "10.0.0.42"
   master_ip: "10.0.0.41"
  tasks:

    - name: Enable kubelet
      ansible.builtin.shell:
        cmd: systemctl --now enable kubelet.service

    - name: initialize the cluster 
      ansible.builtin.shell: 
       cmd: kubeadm init --control-plane-endpoint={{ lb_addr }}:6443 --upload-certs --apiserver-advertise-address={{ master_ip }} --pod-network-cidr=192.168.0.0/16 --cri-socket unix:///run/containerd/containerd.sock

    - name: create user .kube directory
      ansible.builtin.shell: |
        mkdir -p /home/dd/.kube
        cp -i /etc/kubernetes/admin.conf /home/dd/.kube/config
        chown -R dd:dd /home/dd/.kube

    - name: create root .kube directory
      ansible.builtin.shell: |
        mkdir -p ~/.kube
        cp -i /etc/kubernetes/admin.conf ~/.kube/config

    - name: Download Project Calico v3.29.1
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/projectcalico/calico/v3.29.1/manifests/calico.yaml
        dest: ~/calico-cni.yaml
        
    - name: Install Pod network 
      ansible.builtin.shell:
        cmd: kubectl apply -f ~/calico-vxlan.yaml
    
    - name: Download Project Calico v3.29.1 API Server
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/projectcalico/calico/v3.29.1/manifests/apiserver.yaml
        dest: ~/calico-apiserver.yaml

    - name: Create Certificate for Calico API Server 
      ansible.builtin.shell:
        cmd: openssl req -x509 -nodes -newkey rsa:4096 -keyout apiserver.key -out apiserver.crt -days 365 -subj "/" -addext "subjectAltName = DNS:calico-api.calico-apiserver.svc"
  
    - name: Create Secret for Calico API Server 
      ansible.builtin.shell:
        cmd: kubectl create secret -n calico-apiserver generic calico-apiserver-certs --from-file=apiserver.key --from-file=apiserver.crt

    - name: Install Calico API Server 
      ansible.builtin.shell:
        cmd: kubectl apply -f ~/calico-apiserver.yaml
    
    - name: Create the command for joining the other master nodes
      ansible.builtin.shell: 
         kubeadm token create --print-join-command --certificate-key $(kubeadm init phase upload-certs --upload-certs |  awk '{for (i=1;i<3;i++) {getline}; print $0}')
      register: kubernetes_join_command

    - debug: 
        msg: "{{ kubernetes_join_command.stdout }}"

    - name: Copy join command to local file.
      local_action: 
        copy content={{ kubernetes_join_command.stdout }}
        dest="/tmp/kubernetes_join_command" 
        mode=0777

    # Sleep 120 seconds waiting on CNI installation.
    - name: Pause for 2 minutes for CNI install
      ansible.builtin.pause:
        minutes: 2

    - name: Add Calico to FAPolicy Whitelist and reload
      ansible.builtin.shell: | 
        fapolicyd-cli --file add /opt/cni/bin/calico
        fapolicyd-cli --file add /opt/cni/bin/calico-ipam
        fapolicyd-cli --update

    # Install Linkerd
    #- name: Install Linkerd
    #  ansible.builtin.shell: |
    #    curl --proto '=https' --tlsv1.2 -sSfL https://run.linkerd.io/install-edge | sh
    #    export PATH=$HOME/.linkerd2/bin:$PATH
      
    #- name: Deploy Linkerd CRDs & Linkerd
    #  ansible.builtin.shell: |
    #    linkerd install --crds | kubectl apply -f -
    #    linkerd install | kubectl apply -f -

# Create /etc/kubernetes/audit/audit-policy.yaml

# Enable Pod Security auditing using the baseline enforcement by creating the below file


- hosts: ha_masters
  become: yes
  tasks:

    - name: Enable kubelet
      ansible.builtin.shell:
        cmd: systemctl --now enable kubelet.service

    - name: Copy join command from Ansiblehost to the CP nodes.
      become: yes
      copy:
        src: /tmp/kubernetes_join_command
        dest: /tmp/kubernetes_join_command
        mode: 0777

    - name: Join the HA Masters nodes to the cluster as CP nodes
      become: yes
      ansible.builtin.shell:
        cmd: sh /tmp/kubernetes_join_command

    # Sleep 120 seconds waiting on CNI installation.
    - name: Pause for 2 minutes waiting on CNI install
      ansible.builtin.pause:
        minutes: 2

    - name: Add Calico to FAPolicy Whitelist and reload
      ansible.builtin.shell: | 
        fapolicyd-cli --file add /opt/cni/bin/calico
        fapolicyd-cli --file add /opt/cni/bin/calico-ipam
        fapolicyd-cli --update

- hosts: workers
  become: yes
  gather_facts: yes

  tasks:
  - name: Copy Set Firewall Ports file with owner and permissions
    ansible.builtin.copy:
      src: ./setfwports.sh
      dest: /home/dd/setfwports.sh
 
  - name: Execute setting Firewall ports and systemctl
    ansible.builtin.shell:
      cmd: source /home/dd/setfwports.sh

  - name: Copy join command from Ansiblehost to the worker nodes.
    become: yes
    copy:
      src: /tmp/kubernetes_join_command
      dest: /tmp/kubernetes_join_command
      mode: 0777

  - name: Fix to the join command #Remove --control-plane
    ansible.builtin.shell:
      sed -i 's/--control-plane//g' /tmp/kubernetes_join_command

  - name: Join the Worker nodes to the cluster.
    become: yes
    command: sh /tmp/kubernetes_join_command
    register: joined_or_not

  # Sleep 120 seconds waiting on CNI installation.
  - name: Pause for 2 minutes to build app cache
    ansible.builtin.pause:
      minutes: 2

  - name: Add Calico to FAPolicy Whitelist and reload
    become: yes
    ansible.builtin.shell: | 
      fapolicyd-cli --file add /opt/cni/bin/calico
      fapolicyd-cli --file add /opt/cni/bin/calico-ipam
      fapolicyd-cli --update